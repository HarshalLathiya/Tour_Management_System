<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Documents â€“ Tour Support System</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/mobile.css" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="container py-4">

        <h1 class="mb-4">
            <i class="fas fa-file-alt me-2"></i>Rules & Documents
        </h1>

        <!-- CATEGORY FILTER -->
        <div class="btn-group w-100 mb-4" role="group">
            <button class="btn btn-outline-primary active" onclick="setFilter('all', this)">All</button>
            <button class="btn btn-outline-primary" onclick="setFilter('rules', this)">Rules</button>
            <button class="btn btn-outline-primary" onclick="setFilter('safety', this)">Safety</button>
            <button class="btn btn-outline-primary" onclick="setFilter('protocols', this)">Protocols</button>
        </div>

        <div class="row">
            <!-- DOCUMENT LIST -->
            <div class="col-md-4 mb-3">
                <div class="list-group" id="documentList"></div>
                <div id="noDocuments" class="text-center text-muted d-none mt-4">
                    No documents available
                </div>
            </div>

            <!-- DOCUMENT VIEWER -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span id="docTitle">Select a document</span>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" id="printBtn" disabled
                                onclick="printDocument()">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="downloadBtn" disabled
                                onclick="downloadDocument()">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="docPlaceholder" class="text-muted text-center py-5">
                            <i class="fas fa-file-alt fa-2x mb-3"></i><br>
                            No document selected
                        </div>
                        <div id="docContent" class="d-none"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/main.js"></script>

    <script>
        let allDocuments = [];
        let activeDocument = null;
        let activeFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            const stored = DataManager.getData('documents');
            allDocuments = stored && stored.length ? stored : getFallbackDocuments();
            renderList();
        });

        /* ---------------- FILTER ---------------- */
        function setFilter(filter, btn) {
            activeFilter = filter;
            document.querySelectorAll('.btn-group .btn')
                .forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            clearViewer();
            renderList();
        }

        function getFilteredDocs() {
            return activeFilter === 'all'
                ? allDocuments
                : allDocuments.filter(d => d.category === activeFilter);
        }

        /* ---------------- LIST ---------------- */
        function renderList() {
            const list = document.getElementById('documentList');
            const empty = document.getElementById('noDocuments');
            const docs = getFilteredDocs();

            if (!docs.length) {
                list.innerHTML = '';
                empty.classList.remove('d-none');
                return;
            }

            empty.classList.add('d-none');

            list.innerHTML = docs.map(d => `
                <a href="#"
                   class="list-group-item list-group-item-action
                   ${activeDocument && activeDocument.id === d.id ? 'active' : ''}"
                   onclick="openDocument(${d.id})">
                    <strong>${d.title}</strong><br>
                    <small class="text-muted">${d.category.toUpperCase()}</small>
                </a>
            `).join('');
        }

        /* ---------------- VIEW ---------------- */
        function openDocument(id) {
            const doc = allDocuments.find(d => d.id === id);
            if (!doc) return;

            activeDocument = doc;

            document.getElementById('docTitle').textContent = doc.title;
            document.getElementById('docPlaceholder').classList.add('d-none');
            document.getElementById('docContent').classList.remove('d-none');
            document.getElementById('docContent').innerHTML =
                `<pre class="mb-0">${escapeHtml(doc.content)}</pre>`;

            document.getElementById('printBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;

            renderList();
        }

        function clearViewer() {
            activeDocument = null;
            document.getElementById('docTitle').textContent = 'Select a document';
            document.getElementById('docPlaceholder').classList.remove('d-none');
            document.getElementById('docContent').classList.add('d-none');
            document.getElementById('printBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
        }

        /* ---------------- PRINT ---------------- */
        function printDocument() {
            if (!activeDocument) return;
            const win = window.open('', '_blank');
            win.document.write(`<pre>${escapeHtml(activeDocument.content)}</pre>`);
            win.document.close();
            win.print();
        }

        /* ---------------- DOWNLOAD ---------------- */
        function downloadDocument() {
            if (!activeDocument) return;

            const blob = new Blob([activeDocument.content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = activeDocument.title.replace(/\W+/g, '_') + '.txt';
            a.click();

            if (window.TourSupportSystem) {
                TourSupportSystem.showToast('Document downloaded', 'success');
            }
        }

        /* ---------------- UTIL ---------------- */
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        function getFallbackDocuments() {
            return [
                {
                    id: 1,
                    title: 'Tour Rules',
                    category: 'rules',
                    content: 'All students must follow college tour rules strictly.'
                },
                {
                    id: 2,
                    title: 'Emergency Protocol',
                    category: 'safety',
                    content: 'In case of emergency, immediately contact faculty and call 108.'
                }
            ];
        }
    </script>

</body>

</html>