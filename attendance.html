<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance â€“ Tour Support System</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/mobile.css" />

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">

                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="students.html">Students</a></li>
                    <li class="nav-item"><a class="nav-link active" href="attendance.html">Attendance</a></li>
                    <li class="nav-item"><a class="nav-link" href="itinerary.html">Itinerary</a></li>
                    <li class="nav-item"><a class="nav-link" href="safety.html">Safety</a></li>
                    <li class="nav-item"><a class="nav-link" href="documents.html">Documents</a></li>
                </ul>

                <div class="dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        <span id="userRoleLabel"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item logout-btn text-danger" href="#">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="container py-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>
                <i class="fas fa-clipboard-check me-2"></i>Attendance
            </h2>
            <input type="date" id="datePicker" class="form-control w-auto" />
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <strong>Student List</strong>
                <button id="markAllBtn" class="btn btn-sm btn-success">
                    <i class="fas fa-check me-1"></i>Mark All Present
                </button>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody"></tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="text-center text-muted py-3 border-top">
        Kamani Science & Prataprai Arts College Â· Authorized Use Only
    </footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>

    <script>
        let students = [];
        let attendance = [];
        let selectedDate = new Date().toISOString().split('T')[0];

        document.addEventListener('DOMContentLoaded', () => {

            if (!AuthSystem.isLoggedIn()) {
                window.location.replace('index.html');
                return;
            }

            document.getElementById('userRoleLabel').textContent =
                AuthSystem.getRoleName();

            document.getElementById('datePicker').value = selectedDate;
            document.getElementById('datePicker').addEventListener('change', e => {
                selectedDate = e.target.value;
                loadAttendance();
            });

            if (!AuthSystem.hasPermission('editAttendance')) {
                document.getElementById('markAllBtn').classList.add('d-none');
            }

            document.getElementById('markAllBtn').addEventListener('click', markAllPresent);

            students = DataManager.getData('students') || [];
            loadAttendance();
        });

        function loadAttendance() {
            attendance = DataManager.getData('attendance') || [];

            let session = attendance.find(a => a.date === selectedDate);
            if (!session) {
                session = {
                    date: selectedDate,
                    records: students.map(s => ({
                        studentId: s.id,
                        status: 'absent'
                    }))
                };
                attendance.push(session);
                DataManager.updateData('attendance', attendance);
            }

            renderTable(session);
        }

        function renderTable(session) {
            const body = document.getElementById('attendanceBody');
            body.innerHTML = '';

            session.records.forEach(r => {
                const student = students.find(s => s.id === r.studentId);
                if (!student) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${student.fullName}</strong><br>
                        <small class="text-muted">${student.rollNumber}</small>
                    </td>
                    <td>
                        <span class="badge ${r.status === 'present' ? 'bg-success' : 'bg-danger'}">
                            ${r.status}
                        </span>
                    </td>
                    <td>
                        ${AuthSystem.hasPermission('editAttendance') ? `
                            <button class="btn btn-sm btn-outline-success"
                                onclick="mark('${student.id}','present')">Present</button>
                            <button class="btn btn-sm btn-outline-danger"
                                onclick="mark('${student.id}','absent')">Absent</button>
                        ` : '<small>View only</small>'}
                    </td>
                `;
                body.appendChild(row);
            });
        }

        function mark(studentId, status) {
            const session = attendance.find(a => a.date === selectedDate);
            const record = session.records.find(r => r.studentId === Number(studentId));
            record.status = status;
            DataManager.updateData('attendance', attendance);
            renderTable(session);
        }

        function markAllPresent() {
            const session = attendance.find(a => a.date === selectedDate);
            session.records.forEach(r => r.status = 'present');
            DataManager.updateData('attendance', attendance);
            renderTable(session);
        }
    </script>

</body>

</html>