<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Directory – Tour Support System</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/mobile.css" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="container py-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>
                <i class="fas fa-users me-2"></i>Student Directory
            </h2>
            <span class="badge bg-secondary" id="roleBadge"></span>
        </div>

        <!-- FILTERS -->
        <div class="card mb-3">
            <div class="card-body row g-3">
                <div class="col-md-4">
                    <select class="form-select" id="divisionFilter">
                        <option value="">All Divisions</option>
                        <option value="A">Division A</option>
                        <option value="B">Division B</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="healthFilter">
                        <option value="">All Students</option>
                        <option value="alert">Health Alert</option>
                        <option value="no-alert">No Health Alert</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input class="form-control" id="searchFilter" placeholder="Search name or roll" />
                </div>
            </div>
        </div>

        <!-- TABLE -->
        <div class="card">
            <div class="card-body table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Roll</th>
                            <th>Name</th>
                            <th>Division</th>
                            <th>Status</th>
                            <th>Today</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody"></tbody>
                </table>

                <div id="noResults" class="text-center text-muted d-none">
                    No students found
                </div>
            </div>
        </div>

    </main>

    <!-- STUDENT MODAL -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentModalBody"></div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>

    <script>
        let students = [];
        let filtered = [];
        let qrLibLoaded = false;

        document.addEventListener('DOMContentLoaded', () => {

            if (!AuthSystem.isLoggedIn()) {
                window.location.replace('index.html');
                return;
            }

            document.getElementById('roleBadge').textContent =
                AuthSystem.getRoleName();

            students = DataManager.getData('students') || [];
            filtered = [...students];

            bindFilters();
            renderTable();
        });

        function bindFilters() {
            ['divisionFilter', 'healthFilter', 'searchFilter']
                .forEach(id => document.getElementById(id)
                    .addEventListener('input', applyFilters));
        }

        function applyFilters() {
            const div = divisionFilter.value;
            const health = healthFilter.value;
            const search = searchFilter.value.toLowerCase();

            filtered = students.filter(s => {
                if (div && s.division !== div) return false;
                if (health === 'alert' && !s.healthAlert) return false;
                if (health === 'no-alert' && s.healthAlert) return false;
                if (search &&
                    !s.fullName.toLowerCase().includes(search) &&
                    !String(s.rollNumber).toLowerCase().includes(search)) return false;
                return true;
            });

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('studentTableBody');
            const noResults = document.getElementById('noResults');

            if (!filtered.length) {
                tbody.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            }

            noResults.classList.add('d-none');

            tbody.innerHTML = filtered.map(s => `
                <tr class="${s.healthAlert ? 'table-warning' : ''}">
                    <td>${s.rollNumber}</td>
                    <td>${s.fullName}</td>
                    <td>${s.division}</td>
                    <td>
                        ${s.healthAlert
                    ? '<span class="badge bg-danger">Alert</span>'
                    : '<span class="badge bg-success">OK</span>'}
                    </td>
                    <td>${getTodayStatus(s.id)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="viewStudent(${s.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getTodayStatus(id) {
            const today = new Date().toISOString().split('T')[0];
            const sessions = DataManager.getData('attendance') || [];
            const session = sessions.find(s => s.date === today);
            if (!session) return '—';

            const r = session.records.find(x => x.studentId === id);
            if (!r) return '—';

            return r.status === 'present'
                ? '<span class="badge bg-success">Present</span>'
                : '<span class="badge bg-danger">Absent</span>';
        }

        function viewStudent(id) {
            const s = students.find(x => x.id === id);
            if (!s) return;

            document.getElementById('studentModalTitle').innerHTML =
                `<i class="fas fa-user me-2"></i>${s.fullName}`;

            let qrSection = '';
            if (AuthSystem.hasPermission('accessQR')) {
                qrSection = `<div class="text-center mt-3" id="qrBox"></div>`;
            }

            document.getElementById('studentModalBody').innerHTML = `
                <p><strong>Roll:</strong> ${s.rollNumber}</p>
                <p><strong>Division:</strong> ${s.division}</p>
                <p><strong>Emergency Contact:</strong>
                    <a href="tel:${s.emergencyContact}">
                        ${s.emergencyContact}
                    </a>
                </p>
                ${qrSection}
            `;

            if (AuthSystem.hasPermission('accessQR')) {
                generateQR(s);
            }

            new bootstrap.Modal(
                document.getElementById('studentModal')
            ).show();
        }

        function generateQR(student) {
            const data = JSON.stringify({
                id: student.id,
                roll: student.rollNumber,
                name: student.fullName
            });

            const box = document.getElementById('qrBox');
            box.innerHTML = '';

            if (!qrLibLoaded) {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                s.onload = () => {
                    qrLibLoaded = true;
                    new QRCode(box, data);
                };
                document.head.appendChild(s);
            } else {
                new QRCode(box, data);
            }
        }
    </script>

</body>

</html>