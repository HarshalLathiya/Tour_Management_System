<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Itinerary – Tour Support System</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/mobile.css" />
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="students.html">Students</a></li>
                    <li class="nav-item"><a class="nav-link" href="attendance.html">Attendance</a></li>
                    <li class="nav-item"><a class="nav-link active" href="itinerary.html">Itinerary</a></li>
                    <li class="nav-item"><a class="nav-link" href="safety.html">Safety</a></li>
                    <li class="nav-item"><a class="nav-link" href="documents.html">Documents</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="container py-4">

        <div class="row">

            <!-- LEFT -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-route me-2"></i>Tour Timeline
                        </span>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">Expand</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">Collapse</button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div id="timeline"></div>

                        <div id="emptyState" class="text-center text-muted d-none">
                            <p>No itinerary available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="col-lg-4">

                <!-- TODAY -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-calendar-day me-2"></i>Today
                    </div>
                    <div class="card-body" id="todayBox"></div>
                </div>

                <!-- CHECKLIST -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list me-2"></i>Daily Checklist
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input checklist" type="checkbox" id="attendance">
                            <label class="form-check-label">Attendance taken</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input checklist" type="checkbox" id="transport">
                            <label class="form-check-label">Transport confirmed</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input checklist" type="checkbox" id="health">
                            <label class="form-check-label">Health alerts reviewed</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input checklist" type="checkbox" id="emergency">
                            <label class="form-check-label">Emergency plan reviewed</label>
                        </div>
                        <hr />
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetChecklist()">Reset</button>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            if (!AuthSystem.isLoggedIn()) {
                window.location.replace('index.html');
                return;
            }

            loadTimeline();
            loadToday();
            loadChecklist();
        });

        /* ---------- TIMELINE ---------- */
        function loadTimeline() {
            const data = DataManager.getData('itinerary') || [];
            const timeline = document.getElementById('timeline');
            const empty = document.getElementById('emptyState');

            if (!data.length) {
                timeline.innerHTML = '';
                empty.classList.remove('d-none');
                return;
            }

            empty.classList.add('d-none');

            data.sort((a, b) => a.date.localeCompare(b.date));

            timeline.innerHTML = data.map((d, i) => `
                <div class="mb-3">
                    <div class="card">
                        <div class="card-header">
                            <button class="btn btn-link text-decoration-none"
                                data-bs-toggle="collapse"
                                data-bs-target="#day-${i}">
                                Day ${i + 1} · ${d.place}
                            </button>
                        </div>
                        <div id="day-${i}" class="collapse">
                            <div class="card-body">
                                <p><strong>Date:</strong> ${formatDate(d.date)}</p>
                                <p><strong>Reporting:</strong> ${d.reportingTime || '—'}</p>
                                <p><strong>Purpose:</strong> ${d.purpose || '—'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        /* ---------- TODAY ---------- */
        function loadToday() {
            const today = new Date().toISOString().split('T')[0];
            const data = DataManager.getData('itinerary') || [];
            const box = document.getElementById('todayBox');

            const d = data.find(x => x.date === today);

            box.innerHTML = d
                ? `<h5>${d.place}</h5><p>${d.purpose}</p>`
                : `<p class="text-muted">No scheduled activity today</p>`;
        }

        /* ---------- CHECKLIST ---------- */
        function loadChecklist() {
            const today = new Date().toISOString().split('T')[0];
            const saved = JSON.parse(localStorage.getItem('dailyChecklist') || '{}');

            if (saved.date === today) {
                document.querySelectorAll('.checklist').forEach(cb => {
                    cb.checked = !!saved[cb.id];
                });
            }

            document.querySelectorAll('.checklist')
                .forEach(cb => cb.addEventListener('change', saveChecklist));
        }

        function saveChecklist() {
            const today = new Date().toISOString().split('T')[0];
            const data = { date: today };

            document.querySelectorAll('.checklist')
                .forEach(cb => data[cb.id] = cb.checked);

            localStorage.setItem('dailyChecklist', JSON.stringify(data));
        }

        function resetChecklist() {
            if (!confirm('Reset today’s checklist?')) return;
            document.querySelectorAll('.checklist').forEach(cb => cb.checked = false);
            saveChecklist();
        }

        /* ---------- COLLAPSE ---------- */
        function expandAll() {
            document.querySelectorAll('.collapse').forEach(el =>
                new bootstrap.Collapse(el, { toggle: false }).show()
            );
        }

        function collapseAll() {
            document.querySelectorAll('.collapse.show').forEach(el =>
                new bootstrap.Collapse(el, { toggle: false }).hide()
            );
        }

        /* ---------- UTIL ---------- */
        function formatDate(d) {
            return new Date(d).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
    </script>

</body>

</html>