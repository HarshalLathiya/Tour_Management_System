<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Directory - Tour Support System</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation Links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="students.html">
                            <i class="fas fa-users me-1"></i>Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="attendance.html">
                            <i class="fas fa-clipboard-check me-1"></i>Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="itinerary.html">
                            <i class="fas fa-route me-1"></i>Itinerary
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="safety.html">
                            <i class="fas fa-shield-alt me-1"></i>Safety
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documents.html">
                            <i class="fas fa-file-alt me-1"></i>Documents
                        </a>
                    </li>
                </ul>

                <!-- User Info -->
                <div class="navbar-nav align-items-center">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <span class="user-role-display"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text last-login-time"></span></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="TourSupportSystem.exportAllData()">
                                    <i class="fas fa-download me-2"></i>Export Data
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item logout-btn text-danger" href="#">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-1">
                            <i class="fas fa-users me-2"></i>
                            Student Directory
                        </h1>
                        <p class="text-muted mb-0">
                            View and manage student information with health alerts
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="printStudentList()">
                            <i class="fas fa-print me-1"></i>Print List
                        </button>
                        <button class="btn btn-primary" onclick="exportStudentData()">
                            <i class="fas fa-file-export me-1"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Stats -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Division</label>
                                <select class="form-select" id="divisionFilter" onchange="filterStudents()">
                                    <option value="">All Divisions</option>
                                    <option value="A">Division A</option>
                                    <option value="B">Division B</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Health Status</label>
                                <select class="form-select" id="healthFilter" onchange="filterStudents()">
                                    <option value="">All Students</option>
                                    <option value="alert">Health Alert Only</option>
                                    <option value="no-alert">No Health Alert</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Search</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchFilter"
                                        placeholder="Name or Roll Number" oninput="filterStudents()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 class="text-primary" id="totalStudents">0</h3>
                                <small class="text-muted">Total Students</small>
                            </div>
                            <div class="col-6">
                                <h3 class="text-danger" id="healthAlertsCount">0</h3>
                                <small class="text-muted">Health Alerts</small>
                            </div>
                        </div>
                        <hr class="my-2">
                        <div class="row text-center">
                            <div class="col-6">
                                <h5 class="text-success" id="divisionACount">0</h5>
                                <small class="text-muted">Division A</small>
                            </div>
                            <div class="col-6">
                                <h5 class="text-info" id="divisionBCount">0</h5>
                                <small class="text-muted">Division B</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Table -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-list me-2"></i>
                        Student List
                        <span class="badge bg-primary ms-2" id="filteredCount">0</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleColumn('bloodGroup')">
                            <i class="fas fa-tint me-1"></i>Blood Group
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleColumn('emergencyContact')">
                            <i class="fas fa-phone me-1"></i>Emergency Contact
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="studentTable">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Full Name</th>
                                <th class="col-division">Division</th>
                                <th class="col-blood-group d-none">Blood Group</th>
                                <th class="col-emergency-contact">Emergency Contact</th>
                                <th>Health Status</th>
                                <th>Current Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div id="noResults" class="text-center py-5 d-none">
                    <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                    <h4>No Students Found</h4>
                    <p class="text-muted">Try adjusting your filters or search criteria</p>
                    <button class="btn btn-outline-primary" onclick="clearFilters()">
                        Clear All Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Health Alerts Section -->
        <div class="card mt-4 border-danger">
            <div class="card-header bg-danger text-white">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Health Alerts
            </div>
            <div class="card-body">
                <div class="row" id="healthAlertsContainer">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-3 mt-4 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fas fa-university me-1"></i>
                        Kamani Science & Prataprai Arts College, Amreli
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1"></i>
                        Confidential Student Information
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Student Detail Modal -->
    <div class="modal fade" id="studentDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle">
                        <i class="fas fa-user-graduate me-2"></i>Student Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentDetailContent">
                    <!-- Filled by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary print-btn" onclick="printStudentCard()">
                        <i class="fas fa-print me-2"></i>Print Student Card
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/main.js"></script>

    <!-- Students Page JavaScript -->
    <script>
        let allStudents = [];
        let filteredStudents = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadStudents();
            setupEventListeners();
        });

        function loadStudents() {
            const students = DataManager.getData('students') || [];
            allStudents = students;
            filteredStudents = [...students];

            updateStudentTable();
            updateStats();
            loadHealthAlerts();
        }

        function updateStudentTable() {
            const tableBody = document.getElementById('studentTableBody');
            const noResults = document.getElementById('noResults');

            if (filteredStudents.length === 0) {
                tableBody.innerHTML = '';
                noResults.classList.remove('d-none');
                document.getElementById('filteredCount').textContent = '0';
                return;
            }

            noResults.classList.add('d-none');
            document.getElementById('filteredCount').textContent = filteredStudents.length;

            let tableHTML = '';

            filteredStudents.forEach(student => {
                const today = new Date().toISOString().split('T')[0];
                const attendanceData = DataManager.getData('attendance') || [];
                const todayAttendance = attendanceData.find(a => a.date === today);
                let currentStatus = 'Not checked in';

                if (todayAttendance) {
                    const record = todayAttendance.records.find(r => r.studentId === student.id);
                    if (record) {
                        currentStatus = record.status === 'present' ?
                            '<span class="badge bg-success">Present</span>' :
                            record.status === 'absent' ?
                                '<span class="badge bg-danger">Absent</span>' :
                                '<span class="badge bg-warning">With Permission</span>';
                    }
                }

                tableHTML += `
                    <tr class="${student.healthAlert ? 'table-warning' : ''}">
                        <td><strong>${student.rollNumber}</strong></td>
                        <td>
                            <strong>${student.fullName}</strong>
                            ${student.healthAlert ?
                        '<span class="badge bg-danger ms-2 health-alert">Health Alert</span>' : ''}
                        </td>
                        <td class="col-division">
                            <span class="badge bg-primary">Div ${student.division}</span>
                        </td>
                        <td class="col-blood-group d-none">
                            ${student.bloodGroup || 'Not specified'}
                        </td>
                        <td class="col-emergency-contact">
                            <a href="tel:${student.emergencyContact}" class="text-decoration-none">
                                <i class="fas fa-phone text-success me-1"></i>
                                ${student.emergencyContact}
                            </a>
                        </td>
                        <td>
                            ${student.healthAlert ?
                        `<span class="badge bg-danger">Requires Attention</span>
                                 <small class="d-block text-muted">${student.healthNotes || 'Health alert'}</small>` :
                        '<span class="badge bg-success">Good</span>'}
                        </td>
                        <td>${currentStatus}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails(${student.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="generateQRCode(${student.id})">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHTML;
        }

        function filterStudents() {
            const divisionFilter = document.getElementById('divisionFilter').value;
            const healthFilter = document.getElementById('healthFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = allStudents.filter(student => {
                // Division filter
                if (divisionFilter && student.division !== divisionFilter) {
                    return false;
                }

                // Health filter
                if (healthFilter === 'alert' && !student.healthAlert) {
                    return false;
                }
                if (healthFilter === 'no-alert' && student.healthAlert) {
                    return false;
                }

                // Search filter
                if (searchFilter) {
                    const searchInName = student.fullName.toLowerCase().includes(searchFilter);
                    const searchInRoll = student.rollNumber.toLowerCase().includes(searchFilter);
                    if (!searchInName && !searchInRoll) {
                        return false;
                    }
                }

                return true;
            });

            updateStudentTable();
            updateStats();
        }

        function clearFilters() {
            document.getElementById('divisionFilter').value = '';
            document.getElementById('healthFilter').value = '';
            document.getElementById('searchFilter').value = '';
            filteredStudents = [...allStudents];
            updateStudentTable();
            updateStats();
        }

        function updateStats() {
            const totalStudents = allStudents.length;
            const healthAlerts = allStudents.filter(s => s.healthAlert).length;
            const divisionA = allStudents.filter(s => s.division === 'A').length;
            const divisionB = allStudents.filter(s => s.division === 'B').length;
            const filteredCount = filteredStudents.length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('healthAlertsCount').textContent = healthAlerts;
            document.getElementById('divisionACount').textContent = divisionA;
            document.getElementById('divisionBCount').textContent = divisionB;
            document.getElementById('filteredCount').textContent = filteredCount;
        }

        function loadHealthAlerts() {
            const healthAlerts = allStudents.filter(s => s.healthAlert);
            const container = document.getElementById('healthAlertsContainer');

            if (healthAlerts.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            No health alerts - all students have good health status
                        </div>
                    </div>
                `;
                return;
            }

            let alertsHTML = '';

            healthAlerts.forEach(student => {
                alertsHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-danger h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>${student.fullName}</strong>
                                        <small class="ms-2">${student.rollNumber}</small>
                                    </div>
                                    <span class="badge bg-light text-dark">Div ${student.division}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong><i class="fas fa-notes-medical me-2"></i>Health Notes:</strong>
                                    <p class="mb-1">${student.healthNotes || 'Health alert - check details'}</p>
                                </div>
                                <div class="mb-2">
                                    <strong><i class="fas fa-syringe me-2"></i>Medication:</strong>
                                    <p class="mb-1">${student.medication || 'Not specified'}</p>
                                </div>
                                <div>
                                    <strong><i class="fas fa-phone me-2"></i>Emergency Contact:</strong>
                                    <p class="mb-0">
                                        <a href="tel:${student.emergencyContact}" class="text-decoration-none">
                                            ${student.emergencyContact}
                                        </a>
                                    </p>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Notify faculty in case of emergency
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = alertsHTML;
        }

        function viewStudentDetails(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            const today = new Date().toISOString().split('T')[0];
            const attendanceData = DataManager.getData('attendance') || [];
            const studentAttendance = attendanceData.flatMap(session =>
                session.records.filter(r => r.studentId === studentId)
            );

            document.getElementById('studentModalTitle').innerHTML = `
                <i class="fas fa-user-graduate me-2"></i>
                ${student.fullName} - ${student.rollNumber}
            `;

            document.getElementById('studentDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-id-card me-2"></i>Basic Information
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <th>Full Name:</th>
                                        <td>${student.fullName}</td>
                                    </tr>
                                    <tr>
                                        <th>Roll Number:</th>
                                        <td>${student.rollNumber}</td>
                                    </tr>
                                    <tr>
                                        <th>Division:</th>
                                        <td><span class="badge bg-primary">Division ${student.division}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Blood Group:</th>
                                        <td>${student.bloodGroup || 'Not specified'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header ${student.healthAlert ? 'bg-danger text-white' : ''}">
                                <i class="fas fa-heartbeat me-2"></i>Health Information
                            </div>
                            <div class="card-body">
                                ${student.healthAlert ?
                    `<div class="alert alert-danger">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>HEALTH ALERT</strong>
                                    </div>
                                    <p><strong>Health Notes:</strong> ${student.healthNotes || 'No additional notes'}</p>
                                    <p><strong>Medication:</strong> ${student.medication || 'Not specified'}</p>
                                    <p><strong>Special Instructions:</strong> ${student.instructions || 'Contact faculty in emergency'}</p>` :
                    '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No health alerts</div>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <i class="fas fa-address-book me-2"></i>Contact Information
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <th>Emergency Contact:</th>
                                        <td>
                                            <a href="tel:${student.emergencyContact}" class="btn btn-sm btn-success">
                                                <i class="fas fa-phone me-1"></i>${student.emergencyContact}
                                            </a>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Status Today:</th>
                                        <td id="currentStatusCell">
                                            <!-- Filled below -->
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Last Check-in:</th>
                                        <td>${student.lastSeen ? new Date(student.lastSeen).toLocaleString() : 'Never'}</td>
                                    </tr>
                                    <tr>
                                        <th>Notes:</th>
                                        <td>${student.notes || 'No additional notes'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-history me-2"></i>Recent Attendance
                            </div>
                            <div class="card-body">
                                ${studentAttendance.length > 0 ?
                    `<table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Location</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${studentAttendance.slice(-3).map(record => {
                        const session = attendanceData.find(s =>
                            s.records.some(r => r.timestamp === record.timestamp)
                        );
                        const statusClass = record.status === 'present' ? 'success' :
                            record.status === 'absent' ? 'danger' : 'warning';
                        return `
                                                    <tr>
                                                        <td>${session?.date || ''}</td>
                                                        <td>${session?.place || ''}</td>
                                                        <td><span class="badge bg-${statusClass}">${record.status}</span></td>
                                                    </tr>
                                                `;
                    }).join('')}
                                        </tbody>
                                    </table>` :
                    '<p class="text-muted">No attendance records yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-qrcode me-2"></i>Student QR Code
                            </div>
                            <div class="card-body text-center">
                                <div id="qrCodeContainer-${student.id}">
                                    <!-- QR Code will be generated here -->
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="printQRCode(${student.id})">
                                    <i class="fas fa-print me-1"></i>Print QR Code
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Set current status
            const currentStatusCell = document.getElementById('currentStatusCell');
            const todayAttendance = attendanceData.find(a => a.date === today);
            if (todayAttendance) {
                const record = todayAttendance.records.find(r => r.studentId === studentId);
                if (record) {
                    const statusClass = record.status === 'present' ? 'success' :
                        record.status === 'absent' ? 'danger' : 'warning';
                    currentStatusCell.innerHTML = `
                        <span class="badge bg-${statusClass}">${record.status.toUpperCase()}</span>
                        <small class="text-muted ms-2">at ${record.timestamp ? new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</small>
                    `;
                } else {
                    currentStatusCell.innerHTML = '<span class="badge bg-secondary">Not marked</span>';
                }
            } else {
                currentStatusCell.innerHTML = '<span class="badge bg-secondary">No session today</span>';
            }

            // Generate QR code
            setTimeout(() => generateQRCodeForModal(studentId), 100);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
            modal.show();
        }

        function generateQRCode(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            const qrData = {
                id: student.id,
                rollNumber: student.rollNumber,
                fullName: student.fullName,
                division: student.division,
                timestamp: new Date().toISOString()
            };

            const qrString = JSON.stringify(qrData);

            // Create a new window with QR code
            const qrWindow = window.open('', '_blank', 'width=400,height=500');
            qrWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${student.fullName}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }

        .student-card {
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 350px;
        }

        .qr-container {
            margin: 20px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: inline-block;
        }

        .print-button {
            margin-top: 20px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        @media print {
            .print-button {
                display: none;
            }
        }
    </style>
    </head>

    <body>
        <div class="student-card">
            <h3>${student.fullName}</h3>
            <p><strong>${student.rollNumber}</strong> | Division ${student.division}</p>
            <div id="qrcode"></div>
            <p><small>Scan this code for attendance</small></p>
            ${student.healthAlert ?
            '<div style="color: red; border: 1px solid red; padding: 5px; margin: 10px 0;">‚ö†Ô∏è HEALTH ALERT</div>' : ''}
            <p><small>Generated: ${new Date().toLocaleString()}</small></p>
        </div>
        <button class="print-button" onclick="window.print()">Print QR Code</button>

        <script>
                        new QRCode(document.getElementById("qrcode"), {
                            text: '${qrString}',
                            width: 200,
                            height: 200
                        });
        </script>
    </body>

</html>
`);
}

function generateQRCodeForModal(studentId) {
const student = allStudents.find(s => s.id === studentId);
if (!student) return;

const qrData = {
id: student.id,
rollNumber: student.rollNumber,
fullName: student.fullName,
division: student.division,
timestamp: new Date().toISOString()
};

const qrString = JSON.stringify(qrData);

// Clear previous QR code
const container = document.getElementById(`qrCodeContainer-${studentId}`);
container.innerHTML = '';

// Load QR code library if not already loaded
if (typeof QRCode === 'undefined') {
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
script.onload = () => createQRCode();
document.head.appendChild(script);
} else {
createQRCode();
}

function createQRCode() {
new QRCode(container, {
text: qrString,
width: 150,
height: 150,
colorDark: "#000000",
colorLight: "#ffffff",
correctLevel: QRCode.CorrectLevel.H
});
}
}

function printQRCode(studentId) {
const printWindow = window.open('', '_blank');
const student = allStudents.find(s => s.id === studentId);

printWindow.document.write(`
<!DOCTYPE html>
<html>

<head>
    <title>Print QR - ${student.fullName}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }

        .qr-card {
            border: 2px solid black;
            padding: 20px;
            display: inline-block;
            margin: 20px;
        }

        .student-info {
            margin: 20px 0;
        }

        @media print {
            body {
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div class="qr-card">
        <h3>${student.fullName}</h3>
        <div class="student-info">
            <p><strong>${student.rollNumber}</strong> | Division ${student.division}</p>
            <p>Emergency: ${student.emergencyContact}</p>
        </div>
        <p><small>Scan for attendance</small></p>
    </div>
    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 1000);
                        }
    </script>
</body>

</html>
`);
}

function printStudentCard() {
window.print();
}

function printStudentList() {
const printWindow = window.open('', '_blank');
const students = filteredStudents.length > 0 ? filteredStudents : allStudents;

let tableHTML = '';
students.forEach((student, index) => {
tableHTML += `
<tr>
    <td>${index + 1}</td>
    <td>${student.rollNumber}</td>
    <td>${student.fullName}</td>
    <td>${student.division}</td>
    <td>${student.bloodGroup || ''}</td>
    <td>${student.emergencyContact}</td>
    <td>${student.healthAlert ? 'YES' : 'NO'}</td>
</tr>
`;
});

printWindow.document.write(`
<!DOCTYPE html>
<html>

<head>
    <title>Student List - ${new Date().toLocaleDateString()}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .timestamp {
            margin-top: 30px;
            font-size: 12px;
        }

        @media print {
            body {
                margin: 0.5cm;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>Kamani Science & Prataprai Arts College, Amreli</h2>
        <h3>BCA 6th Semester - Student List</h3>
        <p>Educational Tour ${new Date().getFullYear()} | Generated: ${new Date().toLocaleString()}</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Roll No</th>
                <th>Full Name</th>
                <th>Division</th>
                <th>Blood Group</th>
                <th>Emergency Contact</th>
                <th>Health Alert</th>
            </tr>
        </thead>
        <tbody>
            ${tableHTML}
        </tbody>
    </table>

    <div class="timestamp">
        <p>Total Students: ${students.length}</p>
        <p>Health Alerts: ${students.filter(s => s.healthAlert).length}</p>
        <p>Printed for official use only</p>
    </div>

    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 1000);
                        }
    </script>
</body>

</html>
`);
}

function exportStudentData() {
const students = filteredStudents.length > 0 ? filteredStudents : allStudents;

// Create CSV content
let csvContent = "Roll Number,Full Name,Division,Blood Group,Emergency Contact,Health Alert,Health Notes\n";

students.forEach(student => {
const row = [
student.rollNumber,
`"${student.fullName}"`,
student.division,
student.bloodGroup || 'N/A',
student.emergencyContact,
student.healthAlert ? 'YES' : 'NO',
`"${(student.healthNotes || '').replace(/"/g, '""')}"`
];

csvContent += row.join(',') + '\n';
});

// Create download link
const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const link = document.createElement('a');

link.setAttribute('href', url);
link.setAttribute('download', `students_${new Date().toISOString().split('T')[0]}.csv`);
link.style.visibility = 'hidden';

document.body.appendChild(link);
link.click();
document.body.removeChild(link);

TourSupportSystem.showToast('Student data exported successfully', 'success');
}

function toggleColumn(column) {
const columnClass = `.col-${column}`;
const columns = document.querySelectorAll(columnClass);
const isVisible = !columns[0].classList.contains('d-none');

columns.forEach(col => {
if (isVisible) {
col.classList.add('d-none');
} else {
col.classList.remove('d-none');
}
});
}

function setupEventListeners() {
// Add any additional event listeners here
}
</script>
</body>

</html>