<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerary - Tour Support System</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mobile.css">

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-bus text-primary me-2"></i>
                <strong>Tour Support</strong>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation Links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="students.html">
                            <i class="fas fa-users me-1"></i>Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="attendance.html">
                            <i class="fas fa-clipboard-check me-1"></i>Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="itinerary.html">
                            <i class="fas fa-route me-1"></i>Itinerary
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="safety.html">
                            <i class="fas fa-shield-alt me-1"></i>Safety
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documents.html">
                            <i class="fas fa-file-alt me-1"></i>Documents
                        </a>
                    </li>
                </ul>

                <!-- User Info -->
                <div class="navbar-nav align-items-center">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <span class="user-role-display"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text last-login-time"></span></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="printItinerary()">
                                    <i class="fas fa-print me-2"></i>Print Itinerary
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item logout-btn text-danger" href="#">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-1">
                            <i class="fas fa-route me-2"></i>
                            Tour Itinerary
                        </h1>
                        <p class="text-muted mb-0">
                            Daily schedule, locations, and emergency contacts
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="viewToday()">
                            <i class="fas fa-calendar-day me-1"></i>Today's Schedule
                        </button>
                        <button class="btn btn-primary" onclick="printItinerary()">
                            <i class="fas fa-print me-1"></i>Print Full Itinerary
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Itinerary Timeline -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-calendar-alt me-2"></i>
                                Tour Schedule Timeline
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">
                                    <i class="fas fa-expand me-1"></i>Expand All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">
                                    <i class="fas fa-compress me-1"></i>Collapse All
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="timeline" id="itineraryTimeline">
                            <!-- Filled by JavaScript -->
                        </div>

                        <!-- No Itinerary Message -->
                        <div id="noItineraryMessage" class="text-center py-5 d-none">
                            <i class="fas fa-calendar-plus fa-3x text-muted mb-3"></i>
                            <h4>No Itinerary Available</h4>
                            <p class="text-muted">Tour itinerary has not been set up yet</p>
                            <button class="btn btn-primary" onclick="createSampleItinerary()">
                                <i class="fas fa-plus me-2"></i>Create Sample Itinerary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map me-2"></i>
                        Tour Locations Map
                    </div>
                    <div class="card-body">
                        <div id="mapContainer"
                            style="height: 300px; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
                            <div class="text-center py-5">
                                <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                                <h5>Interactive Map</h5>
                                <p class="text-muted">Click on any location to view details</p>
                                <div id="locationButtons" class="mt-3">
                                    <!-- Location buttons will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Today's Details -->
            <div class="col-lg-4">
                <!-- Today's Schedule Card -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-calendar-day me-2"></i>
                        Today's Schedule
                    </div>
                    <div class="card-body" id="todaySchedule">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Emergency Contacts Card -->
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <i class="fas fa-ambulance me-2"></i>
                        Today's Emergency Contacts
                    </div>
                    <div class="card-body" id="todayEmergencyContacts">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Travel Checklist -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Daily Checklist
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkAttendance">
                            <label class="form-check-label" for="checkAttendance">
                                Take morning attendance
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkTransport">
                            <label class="form-check-label" for="checkTransport">
                                Confirm transport arrangements
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkHealth">
                            <label class="form-check-label" for="checkHealth">
                                Check health alert students
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkEmergency">
                            <label class="form-check-label" for="checkEmergency">
                                Review emergency contacts
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="checkEvening">
                            <label class="form-check-label" for="checkEvening">
                                Evening roll call
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="checkReporting">
                            <label class="form-check-label" for="checkReporting">
                                Submit daily report to faculty
                            </label>
                        </div>

                        <hr>
                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="resetChecklist()">
                            <i class="fas fa-redo me-1"></i>Reset Checklist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-3 mt-4 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fas fa-university me-1"></i>
                        Kamani Science & Prataprai Arts College, Amreli
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Follow schedule strictly for safety
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Location Detail Modal -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationModalTitle">
                        <i class="fas fa-map-marker-alt me-2"></i>Location Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="locationDetailContent">
                    <!-- Filled by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary print-btn" onclick="printLocationDetails()">
                        <i class="fas fa-print me-2"></i>Print Details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/main.js"></script>

    <!-- Itinerary Page JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadItinerary();
            loadTodaySchedule();
            loadChecklist();
        });

        function loadItinerary() {
            const itinerary = DataManager.getData('itinerary') || [];
            const timeline = document.getElementById('itineraryTimeline');
            const noItinerary = document.getElementById('noItineraryMessage');

            if (itinerary.length === 0) {
                timeline.innerHTML = '';
                noItinerary.classList.remove('d-none');
                return;
            }

            noItinerary.classList.add('d-none');

            // Sort itinerary by date
            itinerary.sort((a, b) => new Date(a.date) - new Date(b.date));

            let timelineHTML = '';

            itinerary.forEach((item, index) => {
                const isToday = item.date === new Date().toISOString().split('T')[0];
                const isPast = new Date(item.date) < new Date();

                timelineHTML += `
                    <div class="timeline-item ${isToday ? 'timeline-item-today' : isPast ? 'timeline-item-past' : ''}">
                        <div class="timeline-marker">
                            <i class="fas ${isToday ? 'fa-calendar-day text-primary' : isPast ? 'fa-calendar-check text-success' : 'fa-calendar text-secondary'}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="card">
                                <div class="card-header" id="heading-${index}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <button class="btn btn-link text-decoration-none" 
                                                    type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse-${index}"
                                                    aria-expanded="${isToday ? 'true' : 'false'}">
                                                <strong>Day ${index + 1}: ${item.place}</strong>
                                                ${isToday ? '<span class="badge bg-primary ms-2">TODAY</span>' : ''}
                                                ${isPast ? '<span class="badge bg-success ms-2">COMPLETED</span>' : ''}
                                            </button>
                                        </div>
                                        <div>
                                            <small class="text-muted">${formatDate(item.date)}</small>
                                        </div>
                                    </div>
                                </div>
                                <div id="collapse-${index}" 
                                     class="collapse ${isToday ? 'show' : ''}" 
                                     aria-labelledby="heading-${index}">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-clock me-2"></i>Timing</h6>
                                                <p><strong>Reporting:</strong> ${item.reportingTime}</p>
                                                ${item.departureTime ? `<p><strong>Departure:</strong> ${item.departureTime}</p>` : ''}
                                                
                                                <h6 class="mt-3"><i class="fas fa-bullseye me-2"></i>Purpose</h6>
                                                <p>${item.purpose}</p>
                                                
                                                <h6 class="mt-3"><i class="fas fa-graduation-cap me-2"></i>Educational Relevance</h6>
                                                <p>${item.educationalRelevance}</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-road me-2"></i>Travel Notes</h6>
                                                <p>${item.travelNotes}</p>
                                                
                                                ${item.importantNotes ? `
                                                    <h6 class="mt-3"><i class="fas fa-exclamation-circle me-2 text-warning"></i>Important Notes</h6>
                                                    <p>${item.importantNotes}</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewLocationDetails(${item.id})">
                                                <i class="fas fa-info-circle me-1"></i>View Emergency Contacts
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="viewOnMap(${index})">
                                                <i class="fas fa-map-marked-alt me-1"></i>View on Map
                                            </button>
                                            ${AuthSystem.hasPermission('editItinerary') ? `
                                                <button class="btn btn-sm btn-outline-warning float-end" onclick="editItinerary(${item.id})">
                                                    <i class="fas fa-edit me-1"></i>Edit
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            timeline.innerHTML = timelineHTML;

            // Generate location buttons for map
            generateLocationButtons(itinerary);
        }

        function loadTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            const itinerary = DataManager.getData('itinerary') || [];
            const todayItem = itinerary.find(item => item.date === today);
            const todayContainer = document.getElementById('todaySchedule');
            const emergencyContainer = document.getElementById('todayEmergencyContacts');

            if (todayItem) {
                // Today's schedule
                todayContainer.innerHTML = `
                    <h5>${todayItem.place}</h5>
                    <div class="mb-3">
                        <p><strong><i class="fas fa-clock me-2"></i>Reporting Time:</strong> ${todayItem.reportingTime}</p>
                        ${todayItem.departureTime ? `<p><strong><i class="fas fa-bus me-2"></i>Departure:</strong> ${todayItem.departureTime}</p>` : ''}
                    </div>
                    <div class="mb-3">
                        <p><strong><i class="fas fa-bullseye me-2"></i>Purpose:</strong></p>
                        <p class="small">${todayItem.purpose}</p>
                    </div>
                    <div>
                        <p><strong><i class="fas fa-road me-2"></i>Travel Notes:</strong></p>
                        <p class="small">${todayItem.travelNotes}</p>
                    </div>
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='attendance.html'">
                            <i class="fas fa-clipboard-check me-1"></i>Take Today's Attendance
                        </button>
                    </div>
                `;

                // Today's emergency contacts
                if (todayItem.emergencyContacts) {
                    let emergencyHTML = '';

                    if (todayItem.emergencyContacts.hospital) {
                        emergencyHTML += `
                            <div class="mb-3">
                                <h6><i class="fas fa-hospital me-2"></i>Nearest Hospital</h6>
                                <p class="mb-1">${todayItem.emergencyContacts.hospital}</p>
                                <button class="btn btn-sm btn-danger mt-1" onclick="callEmergency('${todayItem.emergencyContacts.hospital.split(' - ')[1]}')">
                                    <i class="fas fa-phone me-1"></i>Call
                                </button>
                            </div>
                        `;
                    }

                    if (todayItem.emergencyContacts.police) {
                        emergencyHTML += `
                            <div class="mb-3">
                                <h6><i class="fas fa-shield-alt me-2"></i>Police Station</h6>
                                <p class="mb-1">${todayItem.emergencyContacts.police}</p>
                                <button class="btn btn-sm btn-warning mt-1" onclick="callEmergency('${todayItem.emergencyContacts.police.split(' - ')[1]}')">
                                    <i class="fas fa-phone me-1"></i>Call
                                </button>
                            </div>
                        `;
                    }

                    if (todayItem.emergencyContacts.faculty) {
                        emergencyHTML += `
                            <div class="mb-3">
                                <h6><i class="fas fa-user-tie me-2"></i>Faculty Contact</h6>
                                <p class="mb-1">${todayItem.emergencyContacts.faculty}</p>
                                <button class="btn btn-sm btn-primary mt-1" onclick="callEmergency('${todayItem.emergencyContacts.faculty.split(' - ')[1]}')">
                                    <i class="fas fa-phone me-1"></i>Call
                                </button>
                            </div>
                        `;
                    }

                    if (todayItem.emergencyContacts.nearestPharmacy) {
                        emergencyHTML += `
                            <div class="mb-3">
                                <h6><i class="fas fa-pills me-2"></i>Nearest Pharmacy</h6>
                                <p class="mb-1">${todayItem.emergencyContacts.nearestPharmacy}</p>
                            </div>
                        `;
                    }

                    emergencyContainer.innerHTML = emergencyHTML;
                } else {
                    emergencyContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No emergency contacts specified for today
                        </div>
                    `;
                }
            } else {
                todayContainer.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-calendar-times fa-2x text-muted mb-3"></i>
                        <h5>No Schedule Today</h5>
                        <p class="text-muted">No tour activities scheduled for today</p>
                    </div>
                `;

                emergencyContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Use general emergency contacts from Safety page
                    </div>
                `;
            }
        }

        function generateLocationButtons(itinerary) {
            const container = document.getElementById('locationButtons');
            let buttonsHTML = '';

            itinerary.forEach((item, index) => {
                buttonsHTML += `
                    <button class="btn btn-sm btn-outline-primary m-1" onclick="showLocationInfo(${index})">
                        ${item.place}
                    </button>
                `;
            });

            container.innerHTML = buttonsHTML;
        }

        function showLocationInfo(index) {
            const itinerary = DataManager.getData('itinerary') || [];
            const item = itinerary[index];

            if (!item) return;

            // Create a simple info display
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = `
                <div class="p-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            ${item.place}
                        </div>
                        <div class="card-body">
                            <p><strong>Date:</strong> ${formatDate(item.date)}</p>
                            <p><strong>Reporting Time:</strong> ${item.reportingTime}</p>
                            <p><strong>Purpose:</strong> ${item.purpose}</p>
                            <p><strong>Travel Notes:</strong> ${item.travelNotes}</p>
                            ${item.coordinates ? `
                                <p><strong>Coordinates:</strong> ${item.coordinates.lat}, ${item.coordinates.lng}</p>
                            ` : ''}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewLocationDetails(${item.id})">
                                    <i class="fas fa-phone-alt me-1"></i>Emergency Contacts
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Scroll to map
            mapContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function viewLocationDetails(itemId) {
            const itinerary = DataManager.getData('itinerary') || [];
            const item = itinerary.find(i => i.id === itemId);

            if (!item) return;

            document.getElementById('locationModalTitle').innerHTML = `
                <i class="fas fa-map-marker-alt me-2"></i>
                ${item.place} - ${formatDate(item.date)}
            `;

            let emergencyHTML = '';
            if (item.emergencyContacts) {
                emergencyHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-danger mb-3">
                                <div class="card-header bg-danger text-white">
                                    <i class="fas fa-hospital me-2"></i>Medical Emergency
                                </div>
                                <div class="card-body">
                                    <h5>${item.emergencyContacts.hospital?.split(' - ')[0] || 'Hospital'}</h5>
                                    <p><i class="fas fa-phone me-2"></i>${item.emergencyContacts.hospital?.split(' - ')[1] || 'Not specified'}</p>
                                    <button class="btn btn-danger w-100" onclick="callEmergency('${item.emergencyContacts.hospital?.split(' - ')[1] || '108'}')">
                                        <i class="fas fa-phone me-2"></i>Call Now
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning mb-3">
                                <div class="card-header bg-warning text-white">
                                    <i class="fas fa-shield-alt me-2"></i>Police Emergency
                                </div>
                                <div class="card-body">
                                    <h5>${item.emergencyContacts.police?.split(' - ')[0] || 'Police Station'}</h5>
                                    <p><i class="fas fa-phone me-2"></i>${item.emergencyContacts.police?.split(' - ')[1] || '100'}</p>
                                    <button class="btn btn-warning w-100" onclick="callEmergency('${item.emergencyContacts.police?.split(' - ')[1] || '100'}')">
                                        <i class="fas fa-phone me-2"></i>Call Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-user-tie me-2"></i>Faculty Contact
                                </div>
                                <div class="card-body">
                                    <h5>${item.emergencyContacts.faculty?.split(' - ')[0] || 'Faculty'}</h5>
                                    <p><i class="fas fa-phone me-2"></i>${item.emergencyContacts.faculty?.split(' - ')[1] || 'Not specified'}</p>
                                    <button class="btn btn-primary w-100" onclick="callEmergency('${item.emergencyContacts.faculty?.split(' - ')[1] || ''}')">
                                        <i class="fas fa-phone me-2"></i>Call Faculty
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <i class="fas fa-pills me-2"></i>Pharmacy
                                </div>
                                <div class="card-body">
                                    <h5>${item.emergencyContacts.nearestPharmacy?.split(' - ')[0] || 'Pharmacy'}</h5>
                                    <p><i class="fas fa-phone me-2"></i>${item.emergencyContacts.nearestPharmacy?.split(' - ')[1] || 'Not specified'}</p>
                                    <p class="small text-muted">For minor medical needs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                emergencyHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No emergency contacts specified for this location
                    </div>
                `;
            }

            document.getElementById('locationDetailContent').innerHTML = `
                <div class="mb-4">
                    <h5>Location Information</h5>
                    <p><strong>Place:</strong> ${item.place}</p>
                    <p><strong>Date:</strong> ${formatDate(item.date)}</p>
                    <p><strong>Reporting Time:</strong> ${item.reportingTime}</p>
                    <p><strong>Purpose:</strong> ${item.purpose}</p>
                    <p><strong>Educational Relevance:</strong> ${item.educationalRelevance}</p>
                </div>
                
                <h5>Emergency Contacts</h5>
                ${emergencyHTML}
                
                ${item.importantNotes ? `
                    <div class="mt-4 alert alert-warning">
                        <h6><i class="fas fa-exclamation-circle me-2"></i>Important Notes</h6>
                        <p>${item.importantNotes}</p>
                    </div>
                ` : ''}
                
                <div class="mt-4">
                    <h6>Quick Actions</h6>
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary" onclick="window.location.href='attendance.html'">
                            <i class="fas fa-clipboard-check me-1"></i>Take Attendance
                        </button>
                        <button class="btn btn-outline-success" onclick="printLocationCard(${item.id})">
                            <i class="fas fa-print me-1"></i>Print Emergency Card
                        </button>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('locationDetailModal'));
            modal.show();
        }

        function callEmergency(number) {
            if (number && confirm(`Call ${number}?`)) {
                window.open(`tel:${number}`, '_blank');
            }
        }

        function printLocationCard(itemId) {
            const itinerary = DataManager.getData('itinerary') || [];
            const item = itinerary.find(i => i.id === itemId);

            if (!item) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Emergency Card - ${item.place}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px;
                        }
                        .emergency-card {
                            border: 3px solid red;
                            padding: 20px;
                            margin: 20px auto;
                            max-width: 400px;
                        }
                        .header {
                            text-align: center;
                            background: red;
                            color: white;
                            padding: 10px;
                            margin: -20px -20px 20px -20px;
                        }
                        .contact-item {
                            margin: 10px 0;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                        }
                        .print-button {
                            display: none;
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="emergency-card">
                        <div class="header">
                            <h2>EMERGENCY CONTACTS</h2>
                            <h3>${item.place}</h3>
                            <p>${formatDate(item.date)} | ${item.reportingTime}</p>
                        </div>
                        
                        ${item.emergencyContacts?.hospital ? `
                            <div class="contact-item">
                                <h4>üöë HOSPITAL</h4>
                                <p><strong>${item.emergencyContacts.hospital.split(' - ')[0]}</strong></p>
                                <h3>${item.emergencyContacts.hospital.split(' - ')[1]}</h3>
                            </div>
                        ` : ''}
                        
                        ${item.emergencyContacts?.police ? `
                            <div class="contact-item">
                                <h4>üëÆ POLICE</h4>
                                <p><strong>${item.emergencyContacts.police.split(' - ')[0]}</strong></p>
                                <h3>${item.emergencyContacts.police.split(' - ')[1]}</h3>
                            </div>
                        ` : ''}
                        
                        ${item.emergencyContacts?.faculty ? `
                            <div class="contact-item">
                                <h4>üë®‚Äçüè´ FACULTY</h4>
                                <p><strong>${item.emergencyContacts.faculty.split(' - ')[0]}</strong></p>
                                <h3>${item.emergencyContacts.faculty.split(' - ')[1]}</h3>
                            </div>
                        ` : ''}
                        
                        <div class="mt-4 text-center">
                            <small>Kamani Science & Prataprai Arts College, Amreli</small><br>
                            <small>Educational Tour ${new Date().getFullYear()}</small>
                        </div>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 1000);
                        }
    </script>
</body>

</html>
`);
}

function printLocationDetails() {
window.print();
}

function printItinerary() {
const itinerary = DataManager.getData('itinerary') || [];
const tourInfo = DataManager.getData('tourInfo');

const printWindow = window.open('', '_blank');

let itineraryHTML = '';
itinerary.forEach((item, index) => {
itineraryHTML += `
<div class="itinerary-day"
    style="page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px;">
    <h3>Day ${index + 1}: ${item.place}</h3>
    <table style="width: 100%;">
        <tr>
            <td style="width: 30%;"><strong>Date:</strong></td>
            <td>${formatDate(item.date)}</td>
        </tr>
        <tr>
            <td><strong>Reporting Time:</strong></td>
            <td>${item.reportingTime}</td>
        </tr>
        <tr>
            <td><strong>Purpose:</strong></td>
            <td>${item.purpose}</td>
        </tr>
        <tr>
            <td><strong>Educational Relevance:</strong></td>
            <td>${item.educationalRelevance}</td>
        </tr>
        <tr>
            <td><strong>Travel Notes:</strong></td>
            <td>${item.travelNotes}</td>
        </tr>
        ${item.emergencyContacts ? `
        <tr>
            <td><strong>Emergency Contacts:</strong></td>
            <td>
                Hospital: ${item.emergencyContacts.hospital || 'N/A'}<br>
                Police: ${item.emergencyContacts.police || 'N/A'}<br>
                Faculty: ${item.emergencyContacts.faculty || 'N/A'}
            </td>
        </tr>
        ` : ''}
    </table>
</div>
`;
});

printWindow.document.write(`
<!DOCTYPE html>
<html>

<head>
    <title>Tour Itinerary - ${tourInfo?.name || 'Educational Tour'}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .college-name {
            font-size: 24px;
            font-weight: bold;
        }

        .tour-name {
            font-size: 20px;
            color: #2c3e50;
        }

        .itinerary-day {
            page-break-inside: avoid;
        }

        .emergency-section {
            border: 2px solid red;
            padding: 15px;
            margin: 20px 0;
            background: #fff0f0;
        }

        @media print {
            body {
                margin: 0.5cm;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="college-name">Kamani Science & Prataprai Arts College, Amreli</div>
        <div class="tour-name">${tourInfo?.name || 'Educational Tour'} ${tourInfo?.academicYear || ''}</div>
        <div>${tourInfo?.dates?.start || ''} to ${tourInfo?.dates?.end || ''}</div>
        <div><strong>Tour Itinerary</strong></div>
        <div>Printed: ${new Date().toLocaleDateString()}</div>
    </div>

    ${itineraryHTML}

    <div class="emergency-section">
        <h3 style="color: red;">‚ö†Ô∏è EMERGENCY PROTOCOL</h3>
        <p>In case of emergency:</p>
        <ol>
            <li>Stay calm and assess the situation</li>
            <li>Immediately contact faculty incharge</li>
            <li>Call emergency services: 108 (Ambulance), 100 (Police)</li>
            <li>Follow instructions from faculty and authorities</li>
            <li>Do not panic or spread rumors</li>
        </ol>
        <p><strong>Tour Incharge:</strong> ${tourInfo?.faculty?.[0]?.name || 'Dr. Ramesh Patel'} -
            ${tourInfo?.faculty?.[0]?.contact || '+91-98765XXXXX'}</p>
    </div>

    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() { window.close(); }, 1000);
                        }
    </script>
</body>

</html>
`);
}

function viewToday() {
const today = new Date().toISOString().split('T')[0];
const itinerary = DataManager.getData('itinerary') || [];
const todayItem = itinerary.find(item => item.date === today);

if (todayItem) {
const index = itinerary.indexOf(todayItem);
const collapseElement = document.getElementById(`collapse-${index}`);

// Expand today's item
if (collapseElement) {
const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: true });
}

// Scroll to today
document.getElementById(`heading-${index}`).scrollIntoView({ behavior: 'smooth' });
} else {
TourSupportSystem.showToast('No schedule for today', 'info');
}
}

function expandAll() {
document.querySelectorAll('.collapse').forEach(collapse => {
new bootstrap.Collapse(collapse, { show: true });
});
}

function collapseAll() {
document.querySelectorAll('.collapse.show').forEach(collapse => {
new bootstrap.Collapse(collapse, { hide: true });
});
}

function viewOnMap(index) {
showLocationInfo(index);
}

function editItinerary(itemId) {
if (!AuthSystem.hasPermission('editItinerary')) {
TourSupportSystem.showToast('You do not have permission to edit itinerary', 'warning');
return;
}

TourSupportSystem.showToast('Edit feature coming soon', 'info');
// In a full implementation, this would open an edit form
}

function createSampleItinerary() {
if (!AuthSystem.hasPermission('editItinerary')) {
TourSupportSystem.showToast('You do not have permission to create itinerary', 'warning');
return;
}

if (confirm('Create sample itinerary with 4 days?')) {
const sampleItinerary = [
{
id: 1,
date: new Date().toISOString().split('T')[0],
place: 'Ahmedabad',
reportingTime: '08:00',
departureTime: '06:00',
purpose: 'Visit to Science City',
educationalRelevance: 'Understanding practical applications of computer science',
travelNotes: 'College bus departure at 06:00',
emergencyContacts: {
hospital: 'Civil Hospital - 079-2268XXXX',
police: 'Police Station - 100',
faculty: 'Dr. Ramesh Patel - +91-98765XXXXX'
}
},
{
id: 2,
date: new Date(Date.now() + 86400000).toISOString().split('T')[0],
place: 'Gandhinagar',
reportingTime: '09:00',
purpose: 'Government Technology Park',
educationalRelevance: 'Exposure to government IT infrastructure',
travelNotes: 'Travel by hired bus',
emergencyContacts: {
hospital: 'General Hospital - 079-2325XXXX',
police: 'Sector 21 Police Station - 100',
faculty: 'Prof. Sunita Sharma - +91-98765XXXXY'
}
}
];

DataManager.updateData('itinerary', sampleItinerary);
loadItinerary();
loadTodaySchedule();

TourSupportSystem.showToast('Sample itinerary created', 'success');
}
}

function formatDate(dateString) {
const date = new Date(dateString);
return date.toLocaleDateString('en-IN', {
weekday: 'short',
day: 'numeric',
month: 'short',
year: 'numeric'
});
}

function loadChecklist() {
const savedChecklist = JSON.parse(localStorage.getItem('dailyChecklist') || '{}');
const today = new Date().toISOString().split('T')[0];

if (savedChecklist.date === today) {
Object.keys(savedChecklist).forEach(key => {
if (key !== 'date') {
const checkbox = document.getElementById(key);
if (checkbox) {
checkbox.checked = savedChecklist[key];
}
}
});
}

// Add change listeners
document.querySelectorAll('#todaySchedule input[type="checkbox"]').forEach(checkbox => {
checkbox.addEventListener('change', saveChecklist);
});
}

function saveChecklist() {
const today = new Date().toISOString().split('T')[0];
const checklist = { date: today };

document.querySelectorAll('#todaySchedule input[type="checkbox"]').forEach(checkbox => {
checklist[checkbox.id] = checkbox.checked;
});

localStorage.setItem('dailyChecklist', JSON.stringify(checklist));
}

function resetChecklist() {
if (confirm('Reset today\'s checklist?')) {
document.querySelectorAll('#todaySchedule input[type="checkbox"]').forEach(checkbox => {
checkbox.checked = false;
});
saveChecklist();
TourSupportSystem.showToast('Checklist reset', 'info');
}
}

// Add some CSS for timeline
const style = document.createElement('style');
style.textContent = `
.timeline {
position: relative;
padding-left: 30px;
}
.timeline:before {
content: '';
position: absolute;
left: 15px;
top: 0;
bottom: 0;
width: 2px;
background: #dee2e6;
}
.timeline-item {
position: relative;
margin-bottom: 20px;
}
.timeline-marker {
position: absolute;
left: -30px;
width: 30px;
height: 30px;
border-radius: 50%;
background: white;
display: flex;
align-items: center;
justify-content: center;
z-index: 1;
}
.timeline-content {
margin-left: 10px;
}
.timeline-item-today .timeline-marker {
background: #007bff;
color: white;
}
.timeline-item-past .timeline-marker {
background: #28a745;
color: white;
}
.btn-link {
text-align: left;
color: #2c3e50;
font-weight: bold;
}
.btn-link:hover {
color: #007bff;
text-decoration: none;
}
`;
document.head.appendChild(style);
</script>
</body>

</html>